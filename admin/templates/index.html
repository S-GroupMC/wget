<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wget Admin - Website Cloner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .log-container {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-download text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Wget Admin</h1>
                        <p class="text-purple-200 text-sm">Website Cloner & Downloader</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-purple-200 text-sm">Powered by GNU Wget</span>
                    <div class="text-purple-200 text-xs mt-1">
                        <i class="fas fa-folder mr-1"></i>
                        <span id="downloadsPath">{{ downloads_dir }}</span>
                        <button onclick="openDownloadsFolder()" class="ml-2 hover:text-white" title="Open folder">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- New Job Form -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-plus-circle text-purple-600 mr-2"></i>
                Clone Website
            </h2>
            
            <form id="newJobForm" class="space-y-4">
                <!-- URL Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Website URL</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                            <i class="fas fa-globe"></i>
                        </span>
                        <input type="text" id="urlInput" 
                               class="flex-1 rounded-none rounded-r-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="https://example.com">
                    </div>
                </div>

                <!-- Presets -->
                <div class="flex flex-wrap gap-2">
                    <span class="text-sm text-gray-600 mr-2">Presets:</span>
                    <button type="button" onclick="applyPreset('quick')" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200">
                        <i class="fas fa-bolt mr-1"></i>Quick
                    </button>
                    <button type="button" onclick="applyPreset('full')" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-full hover:bg-green-200">
                        <i class="fas fa-clone mr-1"></i>Full Mirror
                    </button>
                    <button type="button" onclick="applyPreset('stealth')" class="px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200">
                        <i class="fas fa-user-secret mr-1"></i>Stealth
                    </button>
                </div>

                <!-- Options Toggle -->
                <div>
                    <button type="button" id="toggleOptions" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                        <i class="fas fa-cog mr-1"></i> Advanced Options
                        <i class="fas fa-chevron-down ml-1" id="optionsChevron"></i>
                    </button>
                </div>

                <!-- Advanced Options -->
                <div id="advancedOptions" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                    <!-- Recursive -->
                    <div class="flex items-center">
                        <input type="checkbox" id="recursive" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="recursive" class="ml-2 text-sm text-gray-700">Recursive download</label>
                    </div>
                    
                    <!-- Depth -->
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Depth level</label>
                        <input type="number" id="depth" value="2" min="1" max="10"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                    
                    <!-- Page Requisites -->
                    <div class="flex items-center">
                        <input type="checkbox" id="pageRequisites" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="pageRequisites" class="ml-2 text-sm text-gray-700">Download CSS/JS/Images</label>
                    </div>
                    
                    <!-- Convert Links -->
                    <div class="flex items-center">
                        <input type="checkbox" id="convertLinks" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="convertLinks" class="ml-2 text-sm text-gray-700">Convert links for offline</label>
                    </div>
                    
                    <!-- Span Hosts -->
                    <div class="flex items-center">
                        <input type="checkbox" id="spanHosts" class="w-4 h-4 text-purple-600 rounded">
                        <label for="spanHosts" class="ml-2 text-sm text-gray-700">Download from other hosts</label>
                    </div>
                    
                    <!-- Include Subdomains -->
                    <div class="flex items-center">
                        <input type="checkbox" id="includeSubdomains" class="w-4 h-4 text-purple-600 rounded">
                        <label for="includeSubdomains" class="ml-2 text-sm text-gray-700">Include subdomains</label>
                    </div>
                    
                    <!-- Extra Domains -->
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Extra domains (CDN, etc)</label>
                        <input type="text" id="extraDomains" placeholder="cdn.example.com,images.example.com"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                    
                    <!-- No Parent -->
                    <div class="flex items-center">
                        <input type="checkbox" id="noParent" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="noParent" class="ml-2 text-sm text-gray-700">Stay in directory</label>
                    </div>
                    
                    <!-- Rate Limit -->
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Rate limit</label>
                        <select id="rateLimit" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                            <option value="">No limit</option>
                            <option value="100k">100 KB/s</option>
                            <option value="500k" selected>500 KB/s</option>
                            <option value="1m">1 MB/s</option>
                            <option value="5m">5 MB/s</option>
                        </select>
                    </div>
                    
                    <!-- Wait -->
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Wait between requests (sec)</label>
                        <input type="number" id="wait" value="0.5" min="0" max="10" step="0.1"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                    
                    <!-- Random Wait -->
                    <div class="flex items-center">
                        <input type="checkbox" id="randomWait" class="w-4 h-4 text-purple-600 rounded">
                        <label for="randomWait" class="ml-2 text-sm text-gray-700">Random wait</label>
                    </div>
                    
                    <!-- User Agent -->
                    <div class="md:col-span-2">
                        <label class="block text-sm text-gray-700 mb-1">User Agent</label>
                        <select id="userAgent" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                            <option value="">Default (Wget)</option>
                            <option value="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36">Chrome (Mac)</option>
                            <option value="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36">Chrome (Windows)</option>
                            <option value="Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)">Googlebot</option>
                        </select>
                    </div>
                    
                    <!-- Reject -->
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Reject files</label>
                        <input type="text" id="reject" placeholder="*.mp4,*.zip"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                    
                    <!-- Separator -->
                    <div class="col-span-full border-t border-gray-200 my-2"></div>
                    <div class="col-span-full text-xs text-gray-500 font-medium">Advanced</div>
                    
                    <!-- Ignore robots.txt -->
                    <div class="flex items-center">
                        <input type="checkbox" id="ignoreRobots" class="w-4 h-4 text-purple-600 rounded">
                        <label for="ignoreRobots" class="ml-2 text-sm text-gray-700">Ignore robots.txt</label>
                    </div>
                    
                    <!-- No cookies -->
                    <div class="flex items-center">
                        <input type="checkbox" id="noCookies" class="w-4 h-4 text-purple-600 rounded">
                        <label for="noCookies" class="ml-2 text-sm text-gray-700">No cookies</label>
                    </div>
                    
                    <!-- Mirror mode -->
                    <div class="flex items-center">
                        <input type="checkbox" id="mirrorMode" class="w-4 h-4 text-purple-600 rounded">
                        <label for="mirrorMode" class="ml-2 text-sm text-gray-700">Mirror mode (infinite depth)</label>
                    </div>
                    
                    <!-- Restrict file names -->
                    <div class="flex items-center">
                        <input type="checkbox" id="restrictFileNames" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="restrictFileNames" class="ml-2 text-sm text-gray-700">Fix file names</label>
                    </div>
                    
                    <!-- Trust server names -->
                    <div class="flex items-center">
                        <input type="checkbox" id="trustServerNames" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="trustServerNames" class="ml-2 text-sm text-gray-700">Trust server names</label>
                    </div>
                </div>

                <!-- Wget Version Toggle -->
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-sm text-gray-700 mr-3">Engine:</span>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="useWget2" checked class="sr-only peer">
                                <div class="relative w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                <span class="ms-3 text-sm font-medium text-gray-700" id="wgetVersionLabel">wget2</span>
                            </label>
                        </div>
                        <div id="wget2Badge" class="">
                            <span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">
                                <i class="fas fa-bolt mr-1"></i>HTTP/2, Multi-thread, Brotli
                            </span>
                        </div>
                    </div>
                    <!-- wget2 specific options -->
                    <div id="wget2Options" class="mt-3 pt-3 border-t border-gray-200">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-purple-50 rounded-lg p-3">
                                <label class="block text-xs text-purple-600 font-medium mb-1">Parallel threads</label>
                                <input type="number" id="parallelThreads" value="10" min="1" max="20"
                                       class="w-full border border-purple-200 rounded px-3 py-2 text-sm bg-white">
                            </div>
                            <div class="bg-purple-50 rounded-lg p-3">
                                <label class="block text-xs text-purple-600 font-medium mb-1">Chunk size (for large files)</label>
                                <select id="chunkSize" class="w-full border border-purple-200 rounded px-3 py-2 text-sm bg-white">
                                    <option value="">Disabled</option>
                                    <option value="1M">1 MB</option>
                                    <option value="5M">5 MB</option>
                                    <option value="10M">10 MB</option>
                                </select>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-3">
                                <label class="block text-xs text-purple-600 font-medium mb-1">HTTP/2 window</label>
                                <input type="number" id="http2Window" value="30" min="1" max="100"
                                       class="w-full border border-purple-200 rounded px-3 py-2 text-sm bg-white">
                            </div>
                            <div class="bg-purple-50 rounded-lg p-3 flex items-center justify-between">
                                <div class="flex items-center">
                                    <input type="checkbox" id="progressBar" checked class="w-4 h-4 text-purple-600 rounded">
                                    <label for="progressBar" class="ml-2 text-sm text-gray-700">Progress bar</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="metalink" class="w-4 h-4 text-purple-600 rounded">
                                    <label for="metalink" class="ml-2 text-sm text-gray-700">Metalink</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" 
                        class="w-full gradient-bg text-white py-3 px-6 rounded-lg font-semibold hover:opacity-90 transition-opacity flex items-center justify-center">
                    <i class="fas fa-rocket mr-2"></i>
                    Start Cloning
                </button>
            </form>
        </div>

        <!-- Active Downloads Section -->
        <div id="activeDownloadsSection" class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl card-shadow p-6 mb-8 hidden">
            <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                <i class="fas fa-download text-white mr-2 pulse"></i>
                Active Downloads
                <span id="activeCount" class="ml-2 px-2 py-0.5 bg-white/20 rounded-full text-sm">(0)</span>
            </h2>
            
            <div id="activeDownloadsList" class="space-y-3">
            </div>
        </div>

        <!-- Jobs List -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-tasks text-purple-600 mr-2"></i>
                Jobs History
                <span id="jobCount" class="text-sm font-normal text-gray-500 ml-2">(0)</span>
            </h2>
            
            <div id="jobsList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>No jobs yet. Start cloning a website!</p>
                </div>
            </div>
        </div>

        <!-- Downloaded Sites -->
        <div class="bg-white rounded-xl card-shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-folder text-purple-600 mr-2"></i>
                Downloaded Sites
                <span id="downloadsCount" class="text-sm font-normal text-gray-500 ml-2">(0)</span>
                <button onclick="loadDownloads()" class="ml-2 text-sm text-purple-600 hover:text-purple-800">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </h2>
            
            <div id="downloadsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center text-gray-500 py-8 col-span-full">
                    <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
                    <p>Loading...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- HTML Viewer Modal -->
    <div id="viewerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-5/6 flex flex-col m-4">
            <div class="flex items-center justify-between p-4 border-b">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-globe text-purple-600"></i>
                    <span id="viewerTitle" class="font-semibold text-gray-800">Site Viewer</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="viewerBack()" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button onclick="viewerForward()" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <button onclick="viewerRefresh()" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <input type="text" id="viewerUrl" class="flex-1 px-3 py-1 border rounded text-sm w-64" readonly>
                    <button onclick="openInNewTab()" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                        <i class="fas fa-external-link-alt mr-1"></i>New Tab
                    </button>
                    <button onclick="closeViewer()" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-hidden">
                <iframe id="viewerFrame" class="w-full h-full border-0" sandbox="allow-same-origin allow-scripts"></iframe>
            </div>
        </div>
    </div>

    <!-- Job Template -->
    <template id="jobTemplate">
        <div class="job-card border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <span class="job-status-icon"></span>
                        <a href="#" class="job-url text-purple-600 hover:text-purple-800 font-medium truncate max-w-md" target="_blank"></a>
                    </div>
                    <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                        <span class="job-id"></span>
                        <span class="job-engine hidden px-1.5 py-0.5 text-xs bg-purple-100 text-purple-700 rounded">wget2</span>
                        <span class="job-files"><i class="fas fa-file mr-1"></i><span class="count">0</span> files</span>
                        <span class="job-size"><i class="fas fa-database mr-1"></i><span class="size">0 B</span></span>
                        <span class="job-time"><i class="fas fa-clock mr-1"></i><span class="time">--</span></span>
                    </div>
                    <div class="job-path mt-1 text-xs text-gray-400 truncate max-w-lg">
                        <i class="fas fa-folder-open mr-1"></i>
                        <span class="path"></span>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="btn-folder px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm" title="Open folder">
                        <i class="fas fa-folder-open"></i>
                    </button>
                    <button class="btn-open hidden px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm">
                        <i class="fas fa-external-link-alt mr-1"></i> Open
                    </button>
                    <button class="btn-download hidden px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm">
                        <i class="fas fa-download mr-1"></i> Download
                    </button>
                    <button class="btn-pause hidden px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm">
                        <i class="fas fa-pause mr-1"></i> Pause
                    </button>
                    <button class="btn-resume hidden px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm">
                        <i class="fas fa-play mr-1"></i> Resume
                    </button>
                    <button class="btn-stop hidden px-3 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 text-sm">
                        <i class="fas fa-stop mr-1"></i> Stop
                    </button>
                    <button class="btn-restart hidden px-3 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200 text-sm">
                        <i class="fas fa-redo mr-1"></i> Restart
                    </button>
                    <button class="btn-delete px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm">
                        <i class="fas fa-trash mr-1"></i>
                    </button>
                    <button class="btn-toggle-log px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm">
                        <i class="fas fa-terminal mr-1"></i> Log
                    </button>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="job-progress mt-3 hidden">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="progress-bar bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Log Output -->
            <div class="job-log hidden mt-3">
                <div class="log-container bg-gray-900 text-green-400 p-3 rounded-lg max-h-48 overflow-y-auto">
                    <pre class="log-content whitespace-pre-wrap"></pre>
                </div>
            </div>
            
            <!-- Files List -->
            <div class="job-files-list hidden mt-3">
                <div class="bg-gray-50 rounded-lg p-3 max-h-48 overflow-y-auto">
                    <div class="text-xs text-gray-600 font-medium mb-2">Downloaded files:</div>
                    <div class="files-content grid grid-cols-1 md:grid-cols-2 gap-1 text-xs"></div>
                </div>
            </div>
        </div>
    </template>

    <script>
        const socket = io();
        const jobs = new Map();
        
        // Socket events
        socket.on('connect', () => {
            console.log('Connected to server');
            loadJobs();
        });
        
        socket.on('job_update', (job) => {
            jobs.set(job.id, job);
            updateJobUI(job);
            updateActiveDownloads();
            
            // Refresh downloads list when job completes
            if (job.status === 'completed' || job.status === 'failed' || job.status === 'stopped') {
                loadDownloads();
            }
        });
        
        // Load existing jobs
        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                const jobsList = await response.json();
                jobsList.forEach(job => {
                    jobs.set(job.id, job);
                    updateJobUI(job);
                });
                updateJobCount();
                updateActiveDownloads();
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }
        
        // Toggle advanced options
        document.getElementById('toggleOptions').addEventListener('click', () => {
            const options = document.getElementById('advancedOptions');
            const chevron = document.getElementById('optionsChevron');
            options.classList.toggle('hidden');
            chevron.classList.toggle('fa-chevron-down');
            chevron.classList.toggle('fa-chevron-up');
        });
        
        // Form submit
        document.getElementById('newJobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const url = document.getElementById('urlInput').value.trim();
            if (!url) return;
            
            const options = {
                recursive: document.getElementById('recursive').checked,
                depth: parseInt(document.getElementById('depth').value),
                page_requisites: document.getElementById('pageRequisites').checked,
                convert_links: document.getElementById('convertLinks').checked,
                span_hosts: document.getElementById('spanHosts').checked,
                no_parent: document.getElementById('noParent').checked,
                rate_limit: document.getElementById('rateLimit').value,
                wait: parseFloat(document.getElementById('wait').value),
                random_wait: document.getElementById('randomWait').checked,
                user_agent: document.getElementById('userAgent').value,
                reject: document.getElementById('reject').value,
                ignore_robots: document.getElementById('ignoreRobots').checked,
                no_cookies: document.getElementById('noCookies').checked,
                mirror_mode: document.getElementById('mirrorMode').checked,
                restrict_file_names: document.getElementById('restrictFileNames').checked,
                trust_server_names: document.getElementById('trustServerNames').checked,
                include_subdomains: document.getElementById('includeSubdomains').checked,
                extra_domains: document.getElementById('extraDomains').value,
                // wget2 specific options
                parallel_threads: parseInt(document.getElementById('parallelThreads').value) || 10,
                chunk_size: document.getElementById('chunkSize').value,
                http2_window: parseInt(document.getElementById('http2Window').value) || 30,
                progress_bar: document.getElementById('progressBar').checked,
                metalink: document.getElementById('metalink').checked
            };
            
            const useWget2 = document.getElementById('useWget2').checked;
            
            try {
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, options, use_wget2: useWget2 })
                });
                
                const job = await response.json();
                jobs.set(job.id, job);
                updateJobUI(job);
                updateJobCount();
                
                document.getElementById('urlInput').value = '';
            } catch (error) {
                console.error('Failed to create job:', error);
                alert('Ошибка создания задачи');
            }
        });
        
        function updateJobUI(job) {
            let card = document.querySelector(`[data-job-id="${job.id}"]`);
            
            if (!card) {
                const template = document.getElementById('jobTemplate');
                card = template.content.cloneNode(true).querySelector('.job-card');
                card.dataset.jobId = job.id;
                
                // Add event listeners
                card.querySelector('.btn-toggle-log').addEventListener('click', () => {
                    card.querySelector('.job-log').classList.toggle('hidden');
                });
                
                card.querySelector('.btn-delete').addEventListener('click', () => deleteJob(job.id));
                card.querySelector('.btn-stop').addEventListener('click', () => stopJob(job.id));
                card.querySelector('.btn-pause').addEventListener('click', () => pauseJob(job.id));
                card.querySelector('.btn-resume').addEventListener('click', () => resumeJob(job.id));
                card.querySelector('.btn-restart').addEventListener('click', () => restartJob(job.id));
                card.querySelector('.btn-download').addEventListener('click', () => downloadJob(job.id));
                card.querySelector('.btn-open').addEventListener('click', () => openJob(job.id));
                card.querySelector('.btn-folder').addEventListener('click', () => openJobFolder(job.id));
                
                // Toggle files list
                card.querySelector('.job-path').addEventListener('click', () => {
                    const filesList = card.querySelector('.job-files-list');
                    filesList.classList.toggle('hidden');
                    if (!filesList.classList.contains('hidden')) {
                        loadJobFiles(job.id, card);
                    }
                });
                card.querySelector('.job-path').style.cursor = 'pointer';
                
                const jobsList = document.getElementById('jobsList');
                // Remove empty state
                const emptyState = jobsList.querySelector('.text-center');
                if (emptyState) emptyState.remove();
                
                jobsList.prepend(card);
            }
            
            // Update card content
            card.querySelector('.job-url').textContent = job.url;
            card.querySelector('.job-url').href = job.url;
            card.querySelector('.job-id').textContent = `#${job.id}`;
            card.querySelector('.job-files .count').textContent = job.files_downloaded;
            card.querySelector('.job-size .size').textContent = job.total_size;
            card.querySelector('.job-path .path').textContent = job.output_dir;
            
            // Show wget2 badge if used
            if (job.use_wget2) {
                card.querySelector('.job-engine').classList.remove('hidden');
            }
            
            // Status icon
            const statusIcon = card.querySelector('.job-status-icon');
            const btnStop = card.querySelector('.btn-stop');
            const btnPause = card.querySelector('.btn-pause');
            const btnResume = card.querySelector('.btn-resume');
            const btnRestart = card.querySelector('.btn-restart');
            const btnDownload = card.querySelector('.btn-download');
            const btnOpen = card.querySelector('.btn-open');
            const progressDiv = card.querySelector('.job-progress');
            
            // Reset all buttons
            btnStop.classList.add('hidden');
            btnPause.classList.add('hidden');
            btnResume.classList.add('hidden');
            btnRestart.classList.add('hidden');
            btnDownload.classList.add('hidden');
            btnOpen.classList.add('hidden');
            progressDiv.classList.add('hidden');
            
            switch (job.status) {
                case 'pending':
                    statusIcon.innerHTML = '<i class="fas fa-clock text-yellow-500"></i>';
                    btnStop.classList.remove('hidden');
                    break;
                case 'running':
                    statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i>';
                    btnPause.classList.remove('hidden');
                    btnStop.classList.remove('hidden');
                    progressDiv.classList.remove('hidden');
                    break;
                case 'paused':
                    statusIcon.innerHTML = '<i class="fas fa-pause-circle text-blue-500"></i>';
                    btnResume.classList.remove('hidden');
                    btnStop.classList.remove('hidden');
                    progressDiv.classList.remove('hidden');
                    break;
                case 'completed':
                    statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                    btnDownload.classList.remove('hidden');
                    btnOpen.classList.remove('hidden');
                    btnRestart.classList.remove('hidden');
                    break;
                case 'failed':
                    statusIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                    btnRestart.classList.remove('hidden');
                    break;
                case 'stopped':
                    statusIcon.innerHTML = '<i class="fas fa-stop-circle text-yellow-500"></i>';
                    btnDownload.classList.remove('hidden');
                    btnRestart.classList.remove('hidden');
                    break;
            }
            
            // Time
            if (job.started_at) {
                const started = new Date(job.started_at);
                const ended = job.finished_at ? new Date(job.finished_at) : new Date();
                const duration = Math.round((ended - started) / 1000);
                card.querySelector('.job-time .time').textContent = formatDuration(duration);
            }
            
            // Log
            const logContent = card.querySelector('.log-content');
            logContent.textContent = job.output_lines.join('\n');
            logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
            
            updateJobCount();
        }
        
        function formatDuration(seconds) {
            if (seconds < 60) return `${seconds}s`;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        }
        
        async function deleteJob(jobId) {
            if (!confirm('Удалить эту задачу?')) return;
            
            try {
                await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
                jobs.delete(jobId);
                document.querySelector(`[data-job-id="${jobId}"]`).remove();
                updateJobCount();
                
                if (jobs.size === 0) {
                    document.getElementById('jobsList').innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p>No jobs yet. Start cloning a website!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to delete job:', error);
            }
        }
        
        async function stopJob(jobId) {
            try {
                await fetch(`/api/jobs/${jobId}/stop`, { method: 'POST' });
            } catch (error) {
                console.error('Failed to stop job:', error);
            }
        }
        
        async function pauseJob(jobId) {
            try {
                await fetch(`/api/jobs/${jobId}/pause`, { method: 'POST' });
            } catch (error) {
                console.error('Failed to pause job:', error);
            }
        }
        
        async function resumeJob(jobId) {
            try {
                await fetch(`/api/jobs/${jobId}/resume`, { method: 'POST' });
            } catch (error) {
                console.error('Failed to resume job:', error);
            }
        }
        
        async function restartJob(jobId) {
            if (!confirm('Perезапустить задачу? Текущие файлы будут сохранены.')) return;
            try {
                const response = await fetch(`/api/jobs/${jobId}/restart`, { method: 'POST' });
                if (response.ok) {
                    const job = await response.json();
                    jobs.set(job.id, job);
                    updateJobUI(job);
                    updateActiveDownloads();
                }
            } catch (error) {
                console.error('Failed to restart job:', error);
                alert('Ошибка перезапуска задачи');
            }
        }
        
        function downloadJob(jobId) {
            window.location.href = `/api/jobs/${jobId}/download`;
        }
        
        async function openJob(jobId) {
            try {
                await fetch(`/api/jobs/${jobId}/open`);
            } catch (error) {
                console.error('Failed to open job:', error);
            }
        }
        
        async function openJobFolder(jobId) {
            try {
                await fetch(`/api/jobs/${jobId}/open-folder`);
            } catch (error) {
                console.error('Failed to open folder:', error);
            }
        }
        
        async function openDownloadsFolder() {
            try {
                await fetch('/api/open-downloads');
            } catch (error) {
                console.error('Failed to open downloads folder:', error);
            }
        }
        
        async function loadJobFiles(jobId, card) {
            try {
                const response = await fetch(`/api/jobs/${jobId}/files`);
                const files = await response.json();
                const filesContent = card.querySelector('.files-content');
                
                if (files.length === 0) {
                    filesContent.innerHTML = '<span class="text-gray-400">No files yet...</span>';
                    return;
                }
                
                filesContent.innerHTML = files.slice(0, 50).map(f => `
                    <div class="flex items-center text-gray-600 py-0.5">
                        <i class="fas fa-file text-gray-400 mr-1"></i>
                        <span class="truncate flex-1" title="${f.path}">${f.path}</span>
                        <span class="text-gray-400 ml-2">${f.size}</span>
                    </div>
                `).join('');
                
                if (files.length > 50) {
                    filesContent.innerHTML += `<div class="text-gray-400 mt-1">... and ${files.length - 50} more files</div>`;
                }
            } catch (error) {
                console.error('Failed to load files:', error);
            }
        }
        
        function updateJobCount() {
            document.getElementById('jobCount').textContent = `(${jobs.size})`;
        }
        
        // Wget2 toggle
        document.getElementById('useWget2').addEventListener('change', function() {
            const label = document.getElementById('wgetVersionLabel');
            const badge = document.getElementById('wget2Badge');
            const wget2Options = document.getElementById('wget2Options');
            if (this.checked) {
                label.textContent = 'wget2';
                badge.classList.remove('hidden');
                wget2Options.classList.remove('hidden');
            } else {
                label.textContent = 'wget';
                badge.classList.add('hidden');
                wget2Options.classList.add('hidden');
            }
        });
        
        // Check wget2 availability
        async function checkWget2() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                if (!config.wget2_available) {
                    document.getElementById('useWget2').disabled = true;
                    document.getElementById('wgetVersionLabel').textContent = 'wget (wget2 not installed)';
                }
            } catch (error) {
                console.error('Failed to check wget2:', error);
            }
        }
        checkWget2();
        
        // Load downloaded sites
        async function loadDownloads() {
            try {
                const response = await fetch('/api/downloads');
                const downloads = await response.json();
                const container = document.getElementById('downloadsList');
                
                document.getElementById('downloadsCount').textContent = `(${downloads.length})`;
                
                if (downloads.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8 col-span-full">
                            <i class="fas fa-folder-open text-4xl mb-3"></i>
                            <p>No downloaded sites yet</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = downloads.map(d => {
                    const isActive = d.is_active;
                    const statusBadge = isActive 
                        ? '<span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full animate-pulse"><i class="fas fa-spinner fa-spin mr-1"></i>Downloading</span>'
                        : '';
                    const borderClass = isActive ? 'border-blue-400 border-2 bg-blue-50' : 'border-gray-200';
                    return `
                    <div class="${borderClass} rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-medium text-gray-800 truncate" title="${d.name}">
                                    ${d.name}${statusBadge}
                                </h3>
                                <div class="text-sm text-gray-500 mt-1">
                                    <span><i class="fas fa-file mr-1"></i>${d.files} files</span>
                                    <span class="ml-3"><i class="fas fa-database mr-1"></i>${d.size}</span>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    <i class="fas fa-clock mr-1"></i>${d.date}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 mt-3">
                            <button onclick="openDownloadFolder('${d.path}')" class="px-2 py-1.5 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm" title="Open folder">
                                <i class="fas fa-folder-open"></i>
                            </button>
                            <button onclick="openViewer('${d.name}')" class="px-2 py-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm" title="View site">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="openDownloadInBrowser('${d.path}')" class="px-2 py-1.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm" title="Open in browser">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            ${!isActive ? `
                            <button onclick="continueDownload('${d.name}')" class="px-2 py-1.5 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 text-sm" title="Continue download">
                                <i class="fas fa-play"></i>
                            </button>
                            <button onclick="restartDownload('${d.name}')" class="px-2 py-1.5 bg-orange-100 text-orange-700 rounded hover:bg-orange-200 text-sm" title="Restart from scratch">
                                <i class="fas fa-redo"></i>
                            </button>
                            ` : ''}
                            <button onclick="deleteDownload('${d.name}')" class="px-2 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `}).join('');
            } catch (error) {
                console.error('Failed to load downloads:', error);
                document.getElementById('downloadsList').innerHTML = `
                    <div class="text-center text-red-500 py-8 col-span-full">
                        <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                        <p>Failed to load downloads</p>
                    </div>
                `;
            }
        }
        
        async function openDownloadFolder(path) {
            try {
                await fetch('/api/open-folder?path=' + encodeURIComponent(path));
            } catch (error) {
                console.error('Failed to open folder:', error);
            }
        }
        
        async function openDownloadInBrowser(path) {
            try {
                await fetch('/api/open-site?path=' + encodeURIComponent(path));
            } catch (error) {
                console.error('Failed to open site:', error);
            }
        }
        
        async function deleteDownload(folderName) {
            if (!confirm(`Удалить "${folderName}"? Это действие нельзя отменить.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/downloads/${encodeURIComponent(folderName)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadDownloads(); // Refresh the list
                } else {
                    const data = await response.json();
                    alert('Ошибка удаления: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Failed to delete download:', error);
                alert('Ошибка удаления папки');
            }
        }
        
        async function continueDownload(folderName) {
            if (!confirm(`Продолжить загрузку "${folderName}"? Будут докачаны недостающие файлы.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/downloads/${encodeURIComponent(folderName)}/continue`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ use_wget2: false })
                });
                
                if (response.ok) {
                    const job = await response.json();
                    jobs.set(job.id, job);
                    updateJobUI(job);
                    updateActiveDownloads();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    const data = await response.json();
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Failed to continue download:', error);
                alert('Ошибка продолжения загрузки');
            }
        }
        
        async function restartDownload(folderName) {
            if (!confirm(`Перекачать "${folderName}" заново? Все файлы будут УДАЛЕНЫ и скачаны заново.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/downloads/${encodeURIComponent(folderName)}/restart`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ use_wget2: true })
                });
                
                if (response.ok) {
                    const job = await response.json();
                    jobs.set(job.id, job);
                    updateJobUI(job);
                    updateActiveDownloads();
                    loadDownloads();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    const data = await response.json();
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Failed to restart download:', error);
                alert('Ошибка перезапуска загрузки');
            }
        }
        
        // Update active downloads display
        function updateActiveDownloads() {
            const activeJobs = Array.from(jobs.values()).filter(j => j.status === 'running' || j.status === 'pending' || j.status === 'paused');
            const section = document.getElementById('activeDownloadsSection');
            const list = document.getElementById('activeDownloadsList');
            const count = document.getElementById('activeCount');
            
            count.textContent = `(${activeJobs.length})`;
            
            if (activeJobs.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            
            list.innerHTML = activeJobs.map(job => {
                const isPaused = job.status === 'paused';
                const statusIcon = isPaused ? 'fa-pause' : 'fa-spinner fa-spin';
                const pauseBtn = isPaused 
                    ? `<button onclick="resumeJob('${job.id}')" class="px-2 py-1 bg-green-500/80 text-white rounded hover:bg-green-600 text-sm" title="Resume"><i class="fas fa-play"></i></button>`
                    : `<button onclick="pauseJob('${job.id}')" class="px-2 py-1 bg-blue-500/80 text-white rounded hover:bg-blue-600 text-sm" title="Pause"><i class="fas fa-pause"></i></button>`;
                return `
                <div class="bg-white/10 backdrop-blur rounded-lg p-4" data-active-job="${job.id}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <i class="fas ${statusIcon} text-white"></i>
                            <span class="text-white font-medium truncate max-w-md">${job.url}</span>
                            ${isPaused ? '<span class="px-2 py-0.5 bg-blue-500/50 text-white text-xs rounded">PAUSED</span>' : ''}
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-white/80 text-sm">${job.files_downloaded} files</span>
                            <span class="text-white/80 text-sm">${job.total_size}</span>
                            ${pauseBtn}
                            <button onclick="stopJob('${job.id}')" class="px-2 py-1 bg-red-500/80 text-white rounded hover:bg-red-600 text-sm" title="Stop">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>
                    </div>
                    <div class="w-full bg-white/20 rounded-full h-2">
                        <div class="bg-white h-2 rounded-full transition-all duration-300" style="width: ${Math.min(job.files_downloaded * 2, 100)}%"></div>
                    </div>
                    <div class="mt-2 text-white/60 text-xs truncate">${job.output_lines.slice(-1)[0] || 'Starting...'}</div>
                </div>
            `}).join('');
        }
        
        async function redownload(folderName) {
            // Extract domain from folder name (format: domain_timestamp)
            const parts = folderName.split('_');
            // Remove timestamp parts (last 2 parts: date and time)
            const domain = parts.slice(0, -2).join('_') || parts[0];
            const url = 'https://' + domain;
            
            // Set URL in input
            document.getElementById('urlInput').value = url;
            
            // Apply Full Mirror preset for re-download
            applyPreset('full');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Focus on URL input
            document.getElementById('urlInput').focus();
        }
        
        // Load downloads on page load
        loadDownloads();
        
        // Preset functions
        function applyPreset(preset) {
            // Reset all to defaults first
            document.getElementById('recursive').checked = true;
            document.getElementById('depth').value = 2;
            document.getElementById('pageRequisites').checked = true;
            document.getElementById('convertLinks').checked = true;
            document.getElementById('spanHosts').checked = false;
            document.getElementById('noParent').checked = true;
            document.getElementById('rateLimit').value = '500k';
            document.getElementById('wait').value = 0.5;
            document.getElementById('randomWait').checked = false;
            document.getElementById('userAgent').value = '';
            document.getElementById('reject').value = '';
            document.getElementById('ignoreRobots').checked = false;
            document.getElementById('noCookies').checked = false;
            document.getElementById('mirrorMode').checked = false;
            document.getElementById('restrictFileNames').checked = true;
            document.getElementById('trustServerNames').checked = true;
            document.getElementById('includeSubdomains').checked = false;
            document.getElementById('extraDomains').value = '';
            document.getElementById('useWget2').checked = false;
            document.getElementById('wgetVersionLabel').textContent = 'wget';
            document.getElementById('wget2Badge').classList.add('hidden');
            document.getElementById('wget2Options').classList.add('hidden');
            document.getElementById('parallelThreads').value = 10;
            document.getElementById('chunkSize').value = '';
            document.getElementById('http2Window').value = 30;
            document.getElementById('progressBar').checked = true;
            document.getElementById('metalink').checked = false;
            
            switch(preset) {
                case 'quick':
                    // Quick: single page with resources, fast
                    document.getElementById('recursive').checked = false;
                    document.getElementById('depth').value = 1;
                    document.getElementById('rateLimit').value = '';
                    document.getElementById('wait').value = 0;
                    document.getElementById('useWget2').checked = true;
                    document.getElementById('wgetVersionLabel').textContent = 'wget2';
                    document.getElementById('wget2Badge').classList.remove('hidden');
                    document.getElementById('wget2Options').classList.remove('hidden');
                    document.getElementById('parallelThreads').value = 15;
                    break;
                    
                case 'full':
                    // Full Mirror: complete site clone with subdomains
                    document.getElementById('mirrorMode').checked = true;
                    document.getElementById('depth').value = 5;
                    document.getElementById('spanHosts').checked = true;
                    document.getElementById('includeSubdomains').checked = true;
                    document.getElementById('ignoreRobots').checked = true;
                    document.getElementById('useWget2').checked = true;
                    document.getElementById('wgetVersionLabel').textContent = 'wget2';
                    document.getElementById('wget2Badge').classList.remove('hidden');
                    document.getElementById('wget2Options').classList.remove('hidden');
                    document.getElementById('parallelThreads').value = 20;
                    document.getElementById('chunkSize').value = '5M';
                    document.getElementById('http2Window').value = 50;
                    break;
                    
                case 'stealth':
                    // Stealth: avoid detection
                    document.getElementById('userAgent').value = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';
                    document.getElementById('wait').value = 2;
                    document.getElementById('randomWait').checked = true;
                    document.getElementById('noCookies').checked = true;
                    document.getElementById('ignoreRobots').checked = true;
                    document.getElementById('rateLimit').value = '100k';
                    break;
            }
            
            // Show options panel
            document.getElementById('advancedOptions').classList.remove('hidden');
            document.getElementById('optionsChevron').classList.remove('fa-chevron-down');
            document.getElementById('optionsChevron').classList.add('fa-chevron-up');
        }
        
        // HTML Viewer functions
        let currentViewerPath = '';
        
        async function openViewer(folderName) {
            currentViewerPath = folderName;
            document.getElementById('viewerTitle').textContent = folderName;
            
            try {
                // Use API to find index.html
                const response = await fetch(`/api/find-index/${encodeURIComponent(folderName)}`);
                const data = await response.json();
                
                if (data.path) {
                    loadInViewer(`/api/browse/${data.path}`);
                    document.getElementById('viewerModal').classList.remove('hidden');
                } else {
                    alert('HTML файлы не найдены в этой папке');
                }
            } catch (error) {
                console.error('Failed to open viewer:', error);
                alert('Ошибка открытия просмотрщика');
            }
        }
        
        function loadInViewer(url) {
            document.getElementById('viewerFrame').src = url;
            document.getElementById('viewerUrl').value = url;
        }
        
        function closeViewer() {
            document.getElementById('viewerModal').classList.add('hidden');
            document.getElementById('viewerFrame').src = '';
        }
        
        function viewerBack() {
            try {
                document.getElementById('viewerFrame').contentWindow.history.back();
            } catch (e) {}
        }
        
        function viewerForward() {
            try {
                document.getElementById('viewerFrame').contentWindow.history.forward();
            } catch (e) {}
        }
        
        function viewerRefresh() {
            const frame = document.getElementById('viewerFrame');
            frame.src = frame.src;
        }
        
        function openInNewTab() {
            const url = document.getElementById('viewerUrl').value;
            if (url) {
                window.open(url, '_blank');
            }
        }
        
        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeViewer();
            }
        });
        
        // Close modal on backdrop click
        document.getElementById('viewerModal').addEventListener('click', (e) => {
            if (e.target.id === 'viewerModal') {
                closeViewer();
            }
        });
    </script>
</body>
</html>
