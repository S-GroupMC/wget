<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wget Admin - Website Cloner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .log-container {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-download text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Wget Admin</h1>
                        <p class="text-purple-200 text-sm">Website Cloner & Downloader</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-purple-200 text-sm">Powered by GNU Wget</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- New Job Form -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-plus-circle text-purple-600 mr-2"></i>
                Clone Website
            </h2>
            
            <form id="newJobForm" class="space-y-4">
                <!-- URL Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Website URL</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                            <i class="fas fa-globe"></i>
                        </span>
                        <input type="text" id="urlInput" 
                               class="flex-1 rounded-none rounded-r-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="https://example.com">
                    </div>
                </div>

                <!-- Options Toggle -->
                <div>
                    <button type="button" id="toggleOptions" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                        <i class="fas fa-cog mr-1"></i> Advanced Options
                        <i class="fas fa-chevron-down ml-1" id="optionsChevron"></i>
                    </button>
                </div>

                <!-- Advanced Options -->
                <div id="advancedOptions" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                    <!-- Recursive -->
                    <div class="flex items-center">
                        <input type="checkbox" id="recursive" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="recursive" class="ml-2 text-sm text-gray-700">Recursive download</label>
                    </div>
                    
                    <!-- Depth -->
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Depth level</label>
                        <input type="number" id="depth" value="2" min="1" max="10"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                    
                    <!-- Page Requisites -->
                    <div class="flex items-center">
                        <input type="checkbox" id="pageRequisites" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="pageRequisites" class="ml-2 text-sm text-gray-700">Download CSS/JS/Images</label>
                    </div>
                    
                    <!-- Convert Links -->
                    <div class="flex items-center">
                        <input type="checkbox" id="convertLinks" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="convertLinks" class="ml-2 text-sm text-gray-700">Convert links for offline</label>
                    </div>
                    
                    <!-- Span Hosts -->
                    <div class="flex items-center">
                        <input type="checkbox" id="spanHosts" class="w-4 h-4 text-purple-600 rounded">
                        <label for="spanHosts" class="ml-2 text-sm text-gray-700">Download from other hosts</label>
                    </div>
                    
                    <!-- No Parent -->
                    <div class="flex items-center">
                        <input type="checkbox" id="noParent" checked class="w-4 h-4 text-purple-600 rounded">
                        <label for="noParent" class="ml-2 text-sm text-gray-700">Stay in directory</label>
                    </div>
                    
                    <!-- Rate Limit -->
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Rate limit</label>
                        <select id="rateLimit" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                            <option value="">No limit</option>
                            <option value="100k">100 KB/s</option>
                            <option value="500k" selected>500 KB/s</option>
                            <option value="1m">1 MB/s</option>
                            <option value="5m">5 MB/s</option>
                        </select>
                    </div>
                    
                    <!-- Wait -->
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Wait between requests (sec)</label>
                        <input type="number" id="wait" value="0.5" min="0" max="10" step="0.1"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                    
                    <!-- Random Wait -->
                    <div class="flex items-center">
                        <input type="checkbox" id="randomWait" class="w-4 h-4 text-purple-600 rounded">
                        <label for="randomWait" class="ml-2 text-sm text-gray-700">Random wait</label>
                    </div>
                    
                    <!-- User Agent -->
                    <div class="md:col-span-2">
                        <label class="block text-sm text-gray-700 mb-1">User Agent</label>
                        <select id="userAgent" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                            <option value="">Default (Wget)</option>
                            <option value="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36">Chrome (Mac)</option>
                            <option value="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36">Chrome (Windows)</option>
                            <option value="Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)">Googlebot</option>
                        </select>
                    </div>
                    
                    <!-- Reject -->
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">Reject files</label>
                        <input type="text" id="reject" placeholder="*.mp4,*.zip"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" 
                        class="w-full gradient-bg text-white py-3 px-6 rounded-lg font-semibold hover:opacity-90 transition-opacity flex items-center justify-center">
                    <i class="fas fa-rocket mr-2"></i>
                    Start Cloning
                </button>
            </form>
        </div>

        <!-- Jobs List -->
        <div class="bg-white rounded-xl card-shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-tasks text-purple-600 mr-2"></i>
                Jobs
                <span id="jobCount" class="text-sm font-normal text-gray-500 ml-2">(0)</span>
            </h2>
            
            <div id="jobsList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>No jobs yet. Start cloning a website!</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Job Template -->
    <template id="jobTemplate">
        <div class="job-card border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <span class="job-status-icon"></span>
                        <a href="#" class="job-url text-purple-600 hover:text-purple-800 font-medium truncate max-w-md" target="_blank"></a>
                    </div>
                    <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                        <span class="job-id"></span>
                        <span class="job-files"><i class="fas fa-file mr-1"></i><span class="count">0</span> files</span>
                        <span class="job-size"><i class="fas fa-database mr-1"></i><span class="size">0 B</span></span>
                        <span class="job-time"><i class="fas fa-clock mr-1"></i><span class="time">--</span></span>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="btn-open hidden px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm">
                        <i class="fas fa-external-link-alt mr-1"></i> Open
                    </button>
                    <button class="btn-download hidden px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm">
                        <i class="fas fa-download mr-1"></i> Download
                    </button>
                    <button class="btn-stop hidden px-3 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 text-sm">
                        <i class="fas fa-stop mr-1"></i> Stop
                    </button>
                    <button class="btn-delete px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm">
                        <i class="fas fa-trash mr-1"></i>
                    </button>
                    <button class="btn-toggle-log px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm">
                        <i class="fas fa-terminal mr-1"></i> Log
                    </button>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="job-progress mt-3 hidden">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="progress-bar bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Log Output -->
            <div class="job-log hidden mt-3">
                <div class="log-container bg-gray-900 text-green-400 p-3 rounded-lg max-h-48 overflow-y-auto">
                    <pre class="log-content whitespace-pre-wrap"></pre>
                </div>
            </div>
        </div>
    </template>

    <script>
        const socket = io();
        const jobs = new Map();
        
        // Socket events
        socket.on('connect', () => {
            console.log('Connected to server');
            loadJobs();
        });
        
        socket.on('job_update', (job) => {
            jobs.set(job.id, job);
            updateJobUI(job);
        });
        
        // Load existing jobs
        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                const jobsList = await response.json();
                jobsList.forEach(job => {
                    jobs.set(job.id, job);
                    updateJobUI(job);
                });
                updateJobCount();
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }
        
        // Toggle advanced options
        document.getElementById('toggleOptions').addEventListener('click', () => {
            const options = document.getElementById('advancedOptions');
            const chevron = document.getElementById('optionsChevron');
            options.classList.toggle('hidden');
            chevron.classList.toggle('fa-chevron-down');
            chevron.classList.toggle('fa-chevron-up');
        });
        
        // Form submit
        document.getElementById('newJobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const url = document.getElementById('urlInput').value.trim();
            if (!url) return;
            
            const options = {
                recursive: document.getElementById('recursive').checked,
                depth: parseInt(document.getElementById('depth').value),
                page_requisites: document.getElementById('pageRequisites').checked,
                convert_links: document.getElementById('convertLinks').checked,
                span_hosts: document.getElementById('spanHosts').checked,
                no_parent: document.getElementById('noParent').checked,
                rate_limit: document.getElementById('rateLimit').value,
                wait: parseFloat(document.getElementById('wait').value),
                random_wait: document.getElementById('randomWait').checked,
                user_agent: document.getElementById('userAgent').value,
                reject: document.getElementById('reject').value
            };
            
            try {
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, options })
                });
                
                const job = await response.json();
                jobs.set(job.id, job);
                updateJobUI(job);
                updateJobCount();
                
                document.getElementById('urlInput').value = '';
            } catch (error) {
                console.error('Failed to create job:', error);
                alert('Failed to create job');
            }
        });
        
        function updateJobUI(job) {
            let card = document.querySelector(`[data-job-id="${job.id}"]`);
            
            if (!card) {
                const template = document.getElementById('jobTemplate');
                card = template.content.cloneNode(true).querySelector('.job-card');
                card.dataset.jobId = job.id;
                
                // Add event listeners
                card.querySelector('.btn-toggle-log').addEventListener('click', () => {
                    card.querySelector('.job-log').classList.toggle('hidden');
                });
                
                card.querySelector('.btn-delete').addEventListener('click', () => deleteJob(job.id));
                card.querySelector('.btn-stop').addEventListener('click', () => stopJob(job.id));
                card.querySelector('.btn-download').addEventListener('click', () => downloadJob(job.id));
                card.querySelector('.btn-open').addEventListener('click', () => openJob(job.id));
                
                const jobsList = document.getElementById('jobsList');
                // Remove empty state
                const emptyState = jobsList.querySelector('.text-center');
                if (emptyState) emptyState.remove();
                
                jobsList.prepend(card);
            }
            
            // Update card content
            card.querySelector('.job-url').textContent = job.url;
            card.querySelector('.job-url').href = job.url;
            card.querySelector('.job-id').textContent = `#${job.id}`;
            card.querySelector('.job-files .count').textContent = job.files_downloaded;
            card.querySelector('.job-size .size').textContent = job.total_size;
            
            // Status icon
            const statusIcon = card.querySelector('.job-status-icon');
            const btnStop = card.querySelector('.btn-stop');
            const btnDownload = card.querySelector('.btn-download');
            const btnOpen = card.querySelector('.btn-open');
            const progressDiv = card.querySelector('.job-progress');
            
            switch (job.status) {
                case 'pending':
                    statusIcon.innerHTML = '<i class="fas fa-clock text-yellow-500"></i>';
                    break;
                case 'running':
                    statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i>';
                    btnStop.classList.remove('hidden');
                    progressDiv.classList.remove('hidden');
                    break;
                case 'completed':
                    statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                    btnStop.classList.add('hidden');
                    btnDownload.classList.remove('hidden');
                    btnOpen.classList.remove('hidden');
                    progressDiv.classList.add('hidden');
                    break;
                case 'failed':
                    statusIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                    btnStop.classList.add('hidden');
                    progressDiv.classList.add('hidden');
                    break;
                case 'stopped':
                    statusIcon.innerHTML = '<i class="fas fa-stop-circle text-yellow-500"></i>';
                    btnStop.classList.add('hidden');
                    btnDownload.classList.remove('hidden');
                    progressDiv.classList.add('hidden');
                    break;
            }
            
            // Time
            if (job.started_at) {
                const started = new Date(job.started_at);
                const ended = job.finished_at ? new Date(job.finished_at) : new Date();
                const duration = Math.round((ended - started) / 1000);
                card.querySelector('.job-time .time').textContent = formatDuration(duration);
            }
            
            // Log
            const logContent = card.querySelector('.log-content');
            logContent.textContent = job.output_lines.join('\n');
            logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
            
            updateJobCount();
        }
        
        function formatDuration(seconds) {
            if (seconds < 60) return `${seconds}s`;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        }
        
        async function deleteJob(jobId) {
            if (!confirm('Delete this job?')) return;
            
            try {
                await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
                jobs.delete(jobId);
                document.querySelector(`[data-job-id="${jobId}"]`).remove();
                updateJobCount();
                
                if (jobs.size === 0) {
                    document.getElementById('jobsList').innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p>No jobs yet. Start cloning a website!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to delete job:', error);
            }
        }
        
        async function stopJob(jobId) {
            try {
                await fetch(`/api/jobs/${jobId}/stop`, { method: 'POST' });
            } catch (error) {
                console.error('Failed to stop job:', error);
            }
        }
        
        function downloadJob(jobId) {
            window.location.href = `/api/jobs/${jobId}/download`;
        }
        
        async function openJob(jobId) {
            try {
                await fetch(`/api/jobs/${jobId}/open`);
            } catch (error) {
                console.error('Failed to open job:', error);
            }
        }
        
        function updateJobCount() {
            document.getElementById('jobCount').textContent = `(${jobs.size})`;
        }
    </script>
</body>
</html>
